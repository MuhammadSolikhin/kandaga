<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Models\ChildHealthRecord;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;

class ChildHealthRecordController extends Controller
{
    private function getZScoreBBUByGender($gender, $ageMonth)
    {
        $zScoreBoys = [
            0 => [2.1, 2.5, 2.9, 3.3, 3.9, 4.4, 5.0],
            1 => [2.9, 3.4, 3.9, 4.5, 5.1, 5.8, 6.6],
            2 => [3.8, 4.4, 4.9, 5.6, 6.3, 7.0, 8.0],
            3 => [4.4, 5.0, 5.7, 6.4, 7.2, 8.1, 9.0],
            4 => [4.9, 5.6, 6.2, 7.0, 7.8, 8.7, 9.7],
            5 => [5.3, 6.0, 6.7, 7.5, 8.4, 9.3, 10.4],
            6 => [5.7, 6.4, 7.1, 7.9, 8.9, 9.8, 10.9],
            7 => [5.9, 6.7, 7.4, 8.3, 9.3, 10.3, 11.3],
            8 => [6.2, 6.9, 7.7, 8.6, 9.6, 10.7, 11.8],
            9 => [6.4, 7.1, 8.0, 8.9, 10.0, 11.1, 12.3],
            10 => [6.6, 7.4, 8.2, 9.2, 10.2, 11.4, 12.7],
            11 => [6.8, 7.6, 8.4, 9.4, 10.5, 11.7, 13.0],
            12 => [6.9, 7.7, 8.6, 9.6, 10.8, 12.0, 13.3],
            13 => [7.1, 7.9, 8.8, 9.9, 11.0, 12.3, 13.7],
            14 => [7.2, 8.1, 9.0, 10.1, 11.3, 12.6, 14.0],
            15 => [7.4, 8.3, 9.2, 10.3, 11.5, 12.9, 14.3],
            16 => [7.5, 8.4, 9.4, 10.5, 11.7, 13.1, 14.6],
            17 => [7.7, 8.6, 9.6, 10.7, 12.0, 13.4, 14.9],
            18 => [7.8, 8.8, 9.8, 10.9, 12.2, 13.7, 15.3],
            19 => [8.0, 9.0, 10.0, 11.1, 12.5, 13.9, 15.6],
            20 => [8.1, 9.1, 10.1, 11.3, 12.7, 14.2, 15.9],
            21 => [8.2, 9.2, 10.3, 11.5, 12.9, 14.5, 16.2],
            22 => [8.4, 9.4, 10.5, 11.8, 13.2, 14.8, 16.5],
            23 => [8.5, 9.5, 10.7, 12.0, 13.4, 15.0, 16.8],
            24 => [8.6, 9.6, 10.8, 12.2, 13.6, 15.3, 17.1],
            25 => [8.8, 9.8, 11.0, 12.4, 13.9, 15.5, 17.5],
            26 => [8.9, 10.0, 11.2, 12.5, 14.1, 15.8, 17.8],
            27 => [9.0, 10.1, 11.3, 12.7, 14.3, 16.1, 18.1],
            28 => [9.1, 10.2, 11.5, 12.9, 14.5, 16.3, 18.4],
            29 => [9.2, 10.3, 11.7, 13.1, 14.7, 16.5, 18.7],
            30 => [9.3, 10.4, 11.9, 13.3, 14.9, 16.7, 19.0],
            31 => [9.4, 10.5, 12.1, 13.5, 15.1, 16.9, 19.3],
            32 => [9.5, 10.6, 12.3, 13.7, 15.3, 17.1, 19.6],
            33 => [9.6, 10.7, 12.5, 13.9, 15.5, 17.3, 19.9],
            34 => [9.7, 10.8, 12.7, 14.1, 15.7, 17.5, 20.2],
            35 => [9.8, 10.9, 12.9, 14.3, 15.9, 17.7, 20.5],
            36 => [9.9, 11.0, 13.1, 14.5, 16.1, 17.9, 20.8],
            37 => [10.0, 11.1, 13.3, 14.7, 16.3, 18.1, 21.1],
            38 => [10.1, 11.2, 13.5, 14.9, 16.5, 18.3, 21.4],
            39 => [10.2, 11.3, 13.7, 15.1, 16.7, 18.5, 21.7],
            40 => [10.3, 11.4, 13.9, 15.3, 16.9, 18.7, 22.0],
            41 => [10.4, 11.5, 14.1, 15.5, 17.1, 18.9, 22.3],
            42 => [10.5, 11.6, 14.3, 15.7, 17.3, 19.1, 22.6],
            43 => [10.6, 11.7, 14.5, 15.9, 17.5, 19.3, 22.9],
            44 => [10.7, 11.8, 14.7, 16.1, 17.7, 19.5, 23.2],
            45 => [10.8, 11.9, 14.9, 16.3, 17.9, 19.7, 23.5],
            46 => [10.9, 12.0, 15.1, 16.5, 18.1, 19.9, 23.8],
            47 => [11.0, 12.1, 15.3, 16.7, 18.3, 20.1, 24.1],
            48 => [11.1, 12.2, 15.5, 16.9, 18.5, 20.3, 24.4],
            49 => [11.2, 12.3, 15.7, 17.1, 18.7, 20.5, 24.7],
            50 => [11.3, 12.4, 15.9, 17.3, 18.9, 20.7, 25.0],
            51 => [11.4, 12.5, 16.1, 17.5, 19.1, 20.9, 25.3],
            52 => [11.5, 12.6, 16.3, 17.7, 19.3, 21.1, 25.6],
            53 => [11.6, 12.7, 16.5, 17.9, 19.5, 21.3, 25.9],
            54 => [11.7, 12.8, 16.7, 18.1, 19.7, 21.5, 26.2],
            55 => [11.8, 12.9, 16.9, 18.3, 19.9, 21.7, 26.5],
            56 => [11.9, 13.0, 17.1, 18.5, 20.1, 21.9, 26.8],
            57 => [12.0, 13.1, 17.3, 18.7, 20.3, 22.1, 27.1],
            58 => [12.1, 13.2, 17.5, 18.9, 20.5, 22.3, 27.4],
            59 => [12.2, 13.3, 17.7, 19.1, 20.7, 22.5, 27.7],
            60 => [12.3, 13.4, 17.9, 19.3, 20.9, 22.7, 28.0],
        ];


        $zScoreGirls = [
            0 => [2.0, 2.4, 2.8, 3.2, 3.7, 4.2, 4.8],
            1 => [2.8, 3.2, 3.7, 4.2, 4.8, 5.4, 6.1],
            2 => [3.6, 4.2, 4.7, 5.3, 6.0, 6.7, 7.5],
            3 => [4.2, 4.8, 5.4, 6.1, 6.8, 7.6, 8.5],
            4 => [4.7, 5.4, 6.0, 6.7, 7.5, 8.3, 9.3],
            5 => [5.1, 5.8, 6.4, 7.2, 8.0, 8.9, 9.9],
            6 => [5.4, 6.2, 6.8, 7.6, 8.4, 9.4, 10.5],
            7 => [5.7, 6.5, 7.1, 7.9, 8.8, 9.8, 10.9],
            8 => [5.9, 6.7, 7.4, 8.2, 9.1, 10.2, 11.3],
            9 => [6.1, 6.9, 7.6, 8.5, 9.4, 10.5, 11.6],
            10 => [6.3, 7.1, 7.8, 8.7, 9.6, 10.7, 11.9],
            11 => [6.5, 7.3, 8.0, 8.9, 9.9, 11.0, 12.2],
            12 => [6.6, 7.4, 8.2, 9.1, 10.1, 11.3, 12.5],
            13 => [6.8, 7.6, 8.4, 9.3, 10.3, 11.5, 12.7],
            14 => [6.9, 7.7, 8.5, 9.5, 10.5, 11.7, 13.0],
            15 => [7.1, 7.9, 8.7, 9.6, 10.7, 11.9, 13.2],
            16 => [7.2, 8.0, 8.8, 9.8, 10.9, 12.1, 13.4],
            17 => [7.3, 8.1, 9.0, 9.9, 11.0, 12.3, 13.6],
            18 => [7.4, 8.2, 9.1, 10.1, 11.2, 12.5, 13.8],
            19 => [7.6, 8.4, 9.3, 10.2, 11.4, 12.7, 14.0],
            20 => [7.7, 8.5, 9.4, 10.4, 11.5, 12.9, 14.2],
            21 => [7.8, 8.6, 9.6, 10.5, 11.7, 13.1, 14.4],
            22 => [7.9, 8.7, 9.7, 10.6, 11.9, 13.3, 14.6],
            23 => [8.0, 8.8, 9.8, 10.8, 12.0, 13.4, 14.8],
            24 => [8.1, 8.9, 10.0, 10.9, 12.2, 13.6, 15.0],
            25 => [8.2, 9.0, 10.1, 11.0, 12.3, 13.8, 15.2],
            26 => [8.3, 9.1, 10.2, 11.2, 12.5, 13.9, 15.4],
            27 => [8.4, 9.2, 10.4, 11.3, 12.6, 14.1, 15.6],
            28 => [8.5, 9.3, 10.5, 11.4, 12.8, 14.3, 15.8],
            29 => [8.6, 9.4, 10.6, 11.5, 13.0, 14.5, 16.0],
            30 => [8.7, 9.5, 10.7, 11.6, 13.2, 14.7, 16.2],
            31 => [8.8, 9.6, 10.8, 11.7, 13.4, 14.9, 16.4],
            32 => [8.9, 9.7, 10.9, 11.8, 13.6, 15.1, 16.6],
            33 => [9.0, 9.8, 11.0, 11.9, 13.8, 15.3, 16.8],
            34 => [9.1, 9.9, 11.1, 12.0, 14.0, 15.5, 17.0],
            35 => [9.2, 10.0, 11.2, 12.1, 14.2, 15.7, 17.2],
            36 => [9.3, 10.1, 11.3, 12.2, 14.4, 15.9, 17.4],
            37 => [9.4, 10.2, 11.4, 12.3, 14.6, 16.1, 17.6],
            38 => [9.5, 10.3, 11.5, 12.4, 14.8, 16.3, 17.8],
            39 => [9.6, 10.4, 11.6, 12.5, 15.0, 16.5, 18.0],
            40 => [9.7, 10.5, 11.7, 12.6, 15.2, 16.7, 18.2],
            41 => [9.8, 10.6, 11.8, 12.7, 15.4, 16.9, 18.4],
            42 => [9.9, 10.7, 11.9, 12.8, 15.6, 17.1, 18.6],
            43 => [10.0, 10.8, 12.0, 12.9, 15.8, 17.3, 18.8],
            44 => [10.1, 10.9, 12.1, 13.0, 16.0, 17.5, 19.0],
            45 => [10.2, 11.0, 12.2, 13.1, 16.2, 17.7, 19.2],
            46 => [10.3, 11.1, 12.3, 13.2, 16.4, 17.9, 19.4],
            47 => [10.4, 11.2, 12.4, 13.3, 16.6, 18.1, 19.6],
            48 => [10.5, 11.3, 12.5, 13.4, 16.8, 18.3, 19.8],
            49 => [10.6, 11.4, 12.6, 13.5, 17.0, 18.5, 20.0],
            50 => [10.7, 11.5, 12.7, 13.6, 17.2, 18.7, 20.2],
            51 => [10.8, 11.6, 12.8, 13.7, 17.4, 18.9, 20.4],
            52 => [10.9, 11.7, 12.9, 13.8, 17.6, 19.1, 20.6],
            53 => [11.0, 11.8, 13.0, 13.9, 17.8, 19.3, 20.8],
            54 => [11.1, 11.9, 13.1, 14.0, 18.0, 19.5, 21.0],
            55 => [11.2, 12.0, 13.2, 14.1, 18.2, 19.7, 21.2],
            56 => [11.3, 12.1, 13.3, 14.2, 18.4, 19.9, 21.4],
            57 => [11.4, 12.2, 13.4, 14.3, 18.6, 20.1, 21.6],
            58 => [11.5, 12.3, 13.5, 14.4, 18.8, 20.3, 21.8],
            59 => [11.6, 12.4, 13.6, 14.5, 19.0, 20.5, 22.0],
            60 => [11.7, 12.5, 13.7, 14.6, 19.2, 20.7, 22.2],
        ];

        $table = $gender === 'Laki-laki' ? $zScoreBoys : $zScoreGirls;
        return $table[$ageMonth] ?? null;
    }

    private function evaluateNutritionStatus($gender, $age, $weight)
    {
        $z = $this->getZScoreBBUByGender($gender, $age);

        if (!$z) {
            return 'Data referensi tidak tersedia untuk usia ini.';
        }

        [$minus3, $minus2, $minus1, $median, $plus1, $plus2, $plus3] = $z;

        if ($weight < $minus3) {
            return "Gizi buruk (sangat kurus)";
        } elseif ($weight < $minus2) {
            return "Gizi kurang (kurus)";
        } elseif ($weight <= $plus1) {
            return "Gizi baik (normal)";
        } elseif ($weight <= $plus2) {
            return "Risiko gizi lebih";
        } elseif ($weight <= $plus3) {
            return "Gizi lebih";
        } else {
            return "Obesitas";
        }
    }


    // GET: Ambil semua data
    public function index()
    {
        return response()->json(ChildHealthRecord::all());
    }

    // POST: Simpan data baru
    public function store(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'bpjs_number' => 'required|string',
            'nik' => 'required|string|unique:child_health_records',
            'phone_number' => 'required|string',
            'address' => 'required|string',
            'kelurahan' => 'required|string',
            'gender' => 'required|in:Laki-laki,Perempuan',
            'weight' => 'required|numeric',
            'height' => 'required|numeric',
            'age_months' => 'required|integer',
        ]);

        if ($validator->fails()) {
            return response()->json([
                'message' => 'Validasi gagal',
                'errors' => $validator->errors(),
            ], 422);
        }

        $validated = $validator->validated();

        // Format note hasil berdasarkan input
        $gender = $validated['gender'];
        $bb = $validated['weight'];
        $tb = $validated['height'];
        $usia = $validated['age_months'];

        $statusGizi = $this->evaluateNutritionStatus(
            $validated['gender'],
            $validated['age_months'],
            $validated['weight']
        );

        $note = "Hasil untuk balita $gender: Berat Badan = {$bb} kg, Tinggi Badan = {$tb} cm, Usia = {$usia} bln.";
        $note .= " Perhatikan rentang pertumbuhan $gender.";
        $note .= "\nStatus Gizi: $statusGizi.";
        $note .= "\nCatatan: Data ini bersifat informatif, konsultasikan dengan dokter untuk evaluasi lebih lanjut.";

        $validated['note'] = $note;

        $record = ChildHealthRecord::create($validated);

        return response()->json($record, 201);
    }


}
